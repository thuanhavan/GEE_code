exports.LAI_mod = function(roi,dateOfInterestColl){

  ///// option for year
      
    //--------------------- GPR Trained MODEL PARAMETERS---------------------//
    var X_train_GREEN = ee.Array([
    [-0.169747050059566,-0.0962294124014267,-0.0122075871117409,-0.0713509598140667,-0.0773132740315265,-0.0320148005866971,0.202718888334215,0.151210620009957,-0.722693393005555,-0.774223425750997],
    [-0.159872904348989,-0.0954746558259725,-0.0496819731489956,-0.102342624081538,-0.113417550241683,-0.0638804091888317,0.157347320646693,0.101134536377751,-0.660560933550348,-0.718117601498506],
    [-0.0791721796317195,0.00736092757963139,0.0279340150135739,-0.0457026859375380,-0.0653249815447567,-0.0485683634968970,0.128131800800425,0.0572175432457619,-0.570845861525933,-0.605385651686699],
    [-0.0773656316696340,-0.0271691857473883,-0.00513946447838020,-0.0661411541828968,-0.0660219752939875,-0.0442920264117615,0.126246928552279,0.0497195200281055,-0.468150736527773,-0.540608138987146],
    [-0.365769877562016,-0.233029041702459,-0.0580837038263867,-0.118907134293463,-0.0954351115115277,-0.0219447164829919,0.203795958190298,0.146658248770666,-0.189747688554136,-0.271785797128224],
    [-0.156012336101245,-0.0758509848641695,-0.0222096474419689,-0.106350166874746,-0.152449200198608,-0.157683932346631,0.0489671663782796,-0.0231184198005585,-0.800001061452125,-0.801625961243713],
    [0.899729343495022,1.39460351326403,1.69801136855284,1.58576798517726,1.64175210907135,1.54374644210675,1.50610804792739,1.34259295198689,1.47675749508237,1.85494579451374],
    [1.50257192371970,1.94500974591385,2.12516602505578,1.98678943401756,1.97812129245014,1.86833422150425,1.83851873226120,1.67263986683552,1.88601093001927,2.42562961121489],
    [0.628747149182204,1.10609781229675,1.37901232442077,1.31459092283688,1.43167819305319,1.34524163354193,1.29850283316728,1.12970264991414,1.25867351681025,1.68142530868803],
    [1.41892627835191,1.68443003823836,1.63573187289662,1.53193332698850,1.63129720283289,1.57464642620579,1.59577411344635,1.45720559259964,1.80039984533214,2.14657467698843],
    [-0.149182099970620,0.109630443553644,0.299723334386968,0.106984694483670,-0.0120746591035227,-0.103471013815726,-0.0871475366842863,-0.241632239286550,0.595163750093513,1.17248391372996],
    [0.0484245504026997,0.342472847081196,0.539639421508037,0.392856080399142,0.310772845540191,0.228979707964121,0.258726520850563,0.110774851943309,0.741952878576013,1.24341832522692],
    [1.39219926740599,1.93538659957681,2.16904172970438,2.04663540639613,2.07862779108923,1.99331362147626,1.93101210615237,1.77439875336086,1.85995538250580,2.36423405700969],
    [1.31746262568684,1.73914988995877,1.90965496514046,1.73885611987779,1.67980796777936,1.51436386794114,1.52132165964457,1.37968138825994,1.74170328225234,2.18004739439409],
    [1.14546936080336,1.54310186948460,1.74135362998383,1.66338073060571,1.73124610647259,1.68127896061899,1.68826748733753,1.54410232596141,1.69484147335448,1.93741355164530],
    [-0.0625667867199479,0.235108724222868,0.510833487756981,0.341693117405859,0.230060969379262,0.154350728510637,0.155462448398546,0.0128988702985420,0.733935787033406,1.33169611361802],
    [-0.831958240709492,-0.711261676824484,-0.354078009198933,-0.300181653306218,-0.361338226843083,-0.250935670074090,0.0554295855147815,-0.00952825271855581,-0.638847977289120,-0.730908341957922],
    [-0.925762624959970,-0.773057371439778,-0.485905164351338,-0.451132431850369,-0.550223532884634,-0.508757412400453,-0.297647376682626,-0.395877288335485,-0.831353615877679,-0.811771836726776],
    [-0.457111912192939,-0.254822637818693,0.0259336029475283,0.0417953317141604,-0.0541033821821403,-0.0120125787368723,0.205007661778392,0.102741255638677,-0.115446429436043,-0.205707531161611],
    [-0.857670615128763,-0.710978643108688,-0.403954950045670,-0.386009861460746,-0.491397260449553,-0.438818609104859,-0.207981311163666,-0.301281691848443,-0.793415593399269,-0.784282584349589],
    [-0.938816790028464,-0.794945312127943,-0.527447054922885,-0.486732770330030,-0.579009374727867,-0.531518561401978,-0.309899046295577,-0.409936081868591,-0.766167026311003,-0.734377017336747],
    [-0.907053717297825,-0.763905947962398,-0.445030077801807,-0.387278916678596,-0.452853506117089,-0.360465077996579,-0.0843875451780718,-0.159555663707559,-0.757434123023520,-0.787361033748296],
    [-0.903044665655936,-0.753339355906043,-0.467167971332711,-0.455206767023464,-0.570784848486943,-0.531863427295941,-0.319794625598346,-0.420647543608100,-0.782201209396217,-0.754928918956284],
    [1.20214052290166,1.57291475421504,1.45996233269341,1.36107841923809,1.27276361822856,1.17805064814891,1.22243477458137,1.05780196298768,1.15387867736046,1.78453168432359],
    [0.460465969152327,0.935145447956428,1.07534977279505,0.931870586085559,0.767443150036220,0.669442427733022,0.668416967358365,0.510714054642241,1.12056957083224,1.37106557916768],
    [0.519116909839210,0.918729492440305,0.987064920280235,0.824201269708049,0.635014337682365,0.516735809886429,0.515203780330472,0.344284717864614,0.918328892513374,1.13762372617277],
    [1.29048814241734,1.58951939887502,1.48836818403126,1.34224296811001,1.18131803832948,1.09348953094931,1.15888765307244,0.997549990702942,1.17191713333132,1.68680175552521],
    [0.452546854797979,0.894011214594187,0.967327521228586,0.842101627517710,0.686591875125446,0.553153648288869,0.570403610454757,0.388737284083578,0.979029728478830,1.23656769135375],
    [0.255311412910020,0.700038774702516,0.856104610356451,0.714661766693709,0.519592172809742,0.405964884745675,0.422845040171302,0.255111798883198,0.936844556314157,1.15323276537748],
    [1.19521129784160,1.63065363223726,1.58865550894235,1.45886246339235,1.30161915944672,1.18812073225262,1.20439385449197,1.03289781444332,1.15082454724899,1.58430239808093],
    [0.669085137924660,1.14326957363786,1.33326956851053,1.14133148941054,0.929563896107307,0.837874930344307,0.861077837865321,0.710482816084091,1.15502397615226,1.49593789280537],
    [-0.0416553753779998,-0.145288589805935,-0.521379138322547,-1.09274003304290,0.565454361509130,0.972648521704850,0.440616692796682,0.775956625966842,-1.33170602554576,-1.20746098056622],
    [-0.445035262802560,-0.313221927844444,-0.762762194292049,-0.979192987235352,1.04498606097993,1.15887610444460,-0.190815510332334,0.891104839666568,-0.881221834104016,-0.903951884919045],
    [0.0276368752225381,0.264166852377846,-0.426692967196389,-0.583782098305540,1.21226456079533,1.28578675342280,1.51095486227977,1.03169277499763,-0.836364298091808,-0.851921754236673],
    [-0.714780095497511,-0.730224935782765,-0.596061188788249,-0.591797183891955,-0.836897061943268,-0.951703166605885,-0.898988940707306,-0.949927646811608,-0.140595282072674,-0.444352397224758],
    [-0.640538398425506,-0.813248159082702,-0.620066133580796,-0.594468879087426,-0.861988836915577,-0.933770140119835,-0.936686385670232,-0.850846625721146,-0.268486980490458,-0.498984034441249],
    [-0.519276959874565,-0.428322305601175,-0.171973830786583,0.0387228822393677,0.117984374502947,0.229117654321706,0.160578530214944,0.220299548229793,0.506498535294915,0.174806157895471],
    [-0.0713520542068017,-0.169818178508189,0.213438893938202,0.136239756874085,0.0468910120814044,0.0497873894612075,0.209046673738706,0.190843028446142,0.565672306204636,0.000505220109524109],
    [-0.652912014604173,-0.569839163498795,-0.182642695138826,-0.0507789068089345,-0.256998262583231,-0.344739193231889,-0.311985869141740,-0.299206346136413,0.156227988135763,-0.0983520281869830],
    [-0.826142641105518,-1.10382944063248,-1.02014854678992,-0.932438321314597,-1.03484328672482,-0.888247842116785,-0.746852823535496,-0.620550198321694,-1.17327302601328,-1.12507994031913],
    [-0.323773824251618,-0.177365744262729,-0.0506154987798166,-0.106884505913840,-0.388033087438624,-0.446819497844789,-0.408922156189264,-0.461217204946492,0.611484257876678,0.266726055434328],
    [-0.553923085174834,-0.458512568619334,-0.324005147806048,-0.340657835517614,-0.517673924795555,-0.528207848819938,-0.538170538919297,-0.379542309182733,0.0951453859063739,-0.239700549874094],
    [0.0697071702300075,0.224542132166512,0.382807115530062,0.308564096982010,0.0901046245337148,0.0332338265510076,0.215778360339229,0.111845998117260,0.887310383568763,0.617062268695634],
    [-0.497004450752963,-0.575499837814700,-0.406688846535933,-0.277872998424029,-0.488400187327861,-0.372328464748889,-0.314678543781949,-0.202803190480828,0.00543031388195878,-0.179865899589366],
    [-0.521751683110298,-0.618898340903303,-0.348010092598595,-0.204401380548557,-0.539977724770941,-0.493721259423688,-0.466814660953758,-0.226903979394724,-0.163501257908695,-0.407931305747097],
    [-0.175290430107609,0.0301923139871139,0.542840080813710,0.724012699877860,0.557090436518360,0.463626462216204,0.446002042077100,0.454612773781560,0.711697902159269,0.388996862537903],
    [-0.363369396023354,-0.377376236758032,-0.0279441620312999,0.0694473769872923,-0.149661225201685,-0.147475901885341,-0.0750305008033457,0.0382046986581330,0.677338938405238,0.168735975982527],
    [-0.489580281045763,-0.413227174092096,-0.0919573481447589,0.154941623242387,-0.0660219752939875,-0.00539115357279207,-0.0871475366842863,0.131929988878840,0.677338938405238,0.245914003161379],
    [-0.697457032847376,-0.867968010803115,-0.701416224266650,-0.829578056288936,-0.948416061820198,-0.895145159996035,-0.802052653659781,-0.737037344738859,-0.0632876136261038,-0.376713227337674],
    [-0.0614531612638677,0.260393069500576,0.208104461762080,0.858933307249181,1.03244017349378,1.08990292565210,0.914527429473469,1.00759198608373,0.153364741156260,-0.0567279236410853],
    [-0.462358325452694,-0.490589723076128,-0.215982896239586,0.178986880001632,0.341022374256808,0.379479184089355,0.328870695228007,0.378293608887556,0.0207009644393060,-0.229294523737620],
    [-0.395540798087890,-0.281144773387650,0.140090451516530,0.296541468602387,0.264353061841418,0.344992594693105,0.229241733540274,0.413105859540962,0.489319053417900,0.216430262441369],
    [-0.378217735437755,-0.401905825460286,-0.146635277950005,0.197688746369934,0.223927424386031,0.270501561597206,0.432538668876055,0.526915140523249,0.444461517405692,-0.136507457354056],
    [-0.425237476916692,-0.424548522723905,-0.130631981421640,0.181658575197104,0.249019199358340,0.367064011906705,0.498509197561176,0.600556439982376,0.132367596639908,-0.317745745897652],
    [0.433491485882831,0.375493447257307,0.432150613159187,0.615809044461256,0.463693274121431,0.452590753609404,0.393494886593024,0.498797553457037,0.634390233712699,0.233773639335493],
    [1.04474812510901,0.992506947690930,1.17497029368412,1.28373284332918,1.21365854829379,1.26785372693675,1.34266269726670,1.47621843718727,1.01901974462588,0.195618210168420],
    [-0.789021792569516,-0.950991234103052,-0.825441772361477,-0.822898818300257,-0.896838524377118,-0.719953285863087,-0.544902225519820,-0.380881241900172,-1.35079433874244,-1.32279443691214],
    [-0.185189323050543,-0.226424921667237,0.0467378884344024,0.160285013633330,-0.00189855036475259,0.0318543629751576,0.000364389122506861,0.170759037684562,-0.0174756619540621,-0.433079202243577],
    [-0.343571610137486,-0.450965002864794,-0.572056243995702,-0.466227509704785,-0.643132799657102,-0.768234511017836,-0.773779569937587,-0.706241892237769,-0.706563768354357,-0.690628349121319],
    [0.873992221843394,0.766079975054738,0.894912604437735,1.21560461584465,0.998984473530696,1.09817970710720,1.08012691984632,1.45881231186057,0.921669347322794,0.0534025196366025],
    [0.604247389148443,0.450969104802704,0.566845025606257,0.633175063231822,0.520846761558358,0.573983548284203,0.704498807537166,0.696959595637960,0.724105305737114,0.264124548900210],
    [-0.0540289915566673,0.00943650816212964,0.346799698341242,0.516956322228803,0.356356236739886,0.429139872819955,0.603523508529328,0.742483308030875,0.111370452123555,-0.329018940878833],
    [-0.313874931308684,-0.484929048760223,-0.417357710888176,-0.418136996186294,-0.729560024561722,-0.766855047441986,-0.800706316339677,-0.581721149515973,0.162908897754602,-0.120898418149344],
    [-1.17260389410821,-1.17930509817788,-1.16551182358923,-1.18357766968894,-1.36661231135869,-1.29243066984083,-1.25307565589479,-1.20164699769008,-0.791506762079601,-0.832844039653137],
    [-0.0144334197849313,0.0773645999529873,0.185433125013564,0.541001578988048,0.735520836321449,0.819528064785502,0.794703407984168,0.755872635205262,0.369062680278790,0.153126936777816],
    [0.653741853863113,0.718907689088865,0.574846673870440,0.642525996415973,0.473451186610663,0.375340793361805,0.466197101878667,0.406411195953768,0.494091131717071,0.244179665471967],
    [-0.0614531612638677,-0.316995710721714,-0.368014213259051,-0.476914290486671,-0.944234099324813,-1.03722990830858,-1.18306611524936,-1.17085154518899,-0.266578149170789,-0.0107679748716565],
    [0.943284472443932,0.692491208947976,0.253447135259114,0.249786802681632,-0.152449200198608,-0.248176742922390,-0.425078204030518,-0.394270569074558,0.532267758110439,0.791363206481581],
    [0.987829490687134,1.07175638811360,0.754883759814543,0.671914643566162,0.334052436764500,0.255327462262856,0.159232192894839,-0.0501648606928194,0.685928679343746,0.615327931006222],
    [-0.497004450752963,-0.249067618930856,0.0600739688747063,0.157613318437859,-0.121781475232453,-0.241279425043140,-0.499126756636267,-0.431760685162841,0.237353319221670,0.651749022483882],
    [0.849244989486059,0.647205814420737,0.212105285894172,0.130896366483141,-0.367123274961699,-0.437163252813839,-0.302561507901008,-0.524147042666110,0.0464701872548295,0.314420341893169],
    [-1.22952252853008,-1.37931559067318,-1.58159753332671,-0.943125102096484,-0.509309999804785,-0.361292756142089,-0.527399840358461,-0.316612471463115,-0.152048269990685,-0.393189435387092],
    [-1.56855961182557,-1.74348563832972,-2.28040814839864,-2.05054276061951,-1.12127051162944,-1.03447098115688,-1.17229541668852,-1.03963613888000,-2.21358609523256,-1.83529122413351],
    [-0.895434891706056,-1.24157251565283,-1.49891383459683,-1.44673964644290,-1.26345723647253,-1.30208691487178,-1.14671500760654,-1.14541182355765,-1.03106509269799,-1.05310492620851],
    [-1.34583452060955,-1.66800998078433,-1.99768324306420,-1.99577300911234,-1.20909172403252,-1.01515849109498,-0.962266794752218,-1.10524384203449,-1.36606498929979,-1.39303511333334],
    [-1.72199245244104,-2.02463246268633,-2.38576318387704,-2.03985597983762,-1.12266449912790,-0.868935352054885,-0.931301036389814,-0.984739897465013,-1.69533839194259,-1.49015802394044],
    [0.418643146468430,-0.328317059353524,-0.992142777865277,-1.27575115393271,-1.20909172403252,-1.04826561691538,-1.39578741182587,-1.17620727605874,-1.52354357317243,-1.11207240764853],
    [5.55616858385117,4.15116321596581,2.34454454829878,2.18409412420315,1.56773137290304,1.12714844220005,0.608908857809746,0.572438852916164,-0.0613787823064354,0.295342627309633],
    [2.45286564624136,0.996280730568200,-0.131965589465671,-0.841600684668559,-1.40564396131561,-1.68971617968563,-1.66909388780709,-2.01705702261023,-1.55217604296746,-0.883139832646096],
    [-0.259431020122547,-1.20949536119604,-1.78964038819545,-2.22821049111837,-2.72993208485416,-2.63188980199117,-2.70038827500714,-2.74945321904918,-1.73637826531546,-1.13461879761090],
    [1.05464701805194,0.137745125989305,-0.852113933242085,-1.47879998878856,-1.99251269816796,-2.20011770275013,-2.32745283733819,-2.47764987740913,-1.57221877182398,-0.904819053763751],
    [-0.365844119259088,-0.903818948137178,-1.41756374391097,-1.79406002185422,-2.31870577280798,-2.58222911326057,-2.68153955252568,-2.85790676916172,-2.14868583036384,-1.35401251532156],
    [0.475561780890301,0.232089697921052,-0.0946245642328197,-0.474242595291200,0.218351474392185,0.394653283423705,-0.302561507901008,0.110507065399821,-0.599669214452926,-0.520663255558904],
    [0.0202127055153376,-0.113211435349141,-0.544050475071064,-0.374054025461011,0.724368936333756,0.976786912432400,0.689689097016016,0.943323215646676,-0.591079473514418,-0.638598218438947],
    [-0.155492644221741,-0.283031664826285,-0.602729229008401,-0.340657835517614,0.0273751871029416,0.160144475529207,0.248090456021737,0.232349942686741,-0.0575611196670986,-0.316011408208240],
    [-0.217360725115078,-0.354733539494413,-0.736090033411441,-0.295239017194595,0.201623624410645,0.384997038392755,0.793357070664064,0.536287669545320,0.0827379823285292,-0.205013796085846],
    [-0.00205980360626385,-0.0283013206105690,0.220106934158354,0.363333848489180,0.300596736801421,0.329818495358755,0.331563369868216,0.468002100955947,0.565672306204636,0.0820190915119072],
    [0.257786136145753,0.184917411955179,0.281452904183752,0.392722495639369,0.343810349253731,0.386376501968605,0.405611922473965,0.548338064002268,0.411056969311495,-0.0662667809328535],
    [0.0994038490588095,-0.0113192976628546,0.0774108734471015,0.245779259888425,0.176531849438336,0.201528382804706,0.192890625897452,0.384988272474749,0.774689335708326,0.179142002119002],
    [0.312230047331890,0.239637263675592,0.309458673108391,0.562375140551822,0.544544549032206,0.551912131070604,0.534860305203997,0.726416115421611,0.814774793421363,0.0967609618719126],
    [-2.09072621456533,-2.14916729763624,-2.07636611766199,-2.21752371033649,-2.45113458516183,-2.57809072253302,-2.52401808607345,-2.65706686154592,-2.24985389030626,-1.69480987129110],
    [-1.95214171336426,-2.00198976542271,-2.13504487159933,-2.35511601290328,-2.66720264742339,-2.87191646418907,-3.07332371267609,-3.17389489047724,-2.45887091980995,-1.70695023511699]
    ]);
    
    var alpha_coefficients_GREEN = ee.Image([[-0.0649692133252533,0.861939704801132,1.70344459778606,3.16559186618655,6.20349944893887,-1.76898259982893,0.293098851232115,-0.246090774451043,0.167788988514795,-0.201524056564397,0.752245072493576,-0.107552591593015,-0.242012111111828,
    0.163616734497043,0.105158871134985,0.252046697909512,4.02561483213110,1.18219274985439,1.95592857613241,-1.71204566332826,2.13926762091068,-1.70586872684228,-3.66152504319817,0.203411657676671,-0.251814298055121,-0.801761029906925,0.182900379309785,-0.449585612368720,
    -0.828681325020211,0.426675293585757,-0.00769662714342161,-2.23716400499776,1.44167493052489,0.175840725727249,-2.14042152609556,-1.67842415458057,-0.498301189060109,1.48711961603507,-3.24866360511794,9.00909549260882,0.716506117832890,.67459418772832,1.38406843835388,
    -0.885220886663688,-5.03275840335400,-1.06004653335945,-2.74844074345452,-1.45851451662985,-1.67165866136224,0.0111621001654366,-0.933323407530021,-1.35184423494661,2.43959537761688,-0.987739149446284,2.38507340214498,-0.657591713314807,0.729479364485216,
    -5.31483315404407,0.473954294945387,-0.0451263673447248,-0.530541011506251,0.214142152754284,1.82272514271066,0.782062016801854,1.59861787888819,0.446173646417087,-1.43626206642831,1.75051888839336,-1.31669199824356,-0.414228949169271,-1.19908377961312,-0.227234849461707,-1.00019543249435,-4.15707405823348,
    0.224256874639066,0.663000859719916,-1.29734779659001,-0.108281064511729,0.0547263919769594,1.16215400771180,0.836134379610679,-1.25877301603122,-2.12197739989053,-1.20722829223951,-2.84335580665019,-0.770693838019563,0.705592963652411,
    1.53064029112782,-0.951870018536151,-0.279238224334097,-0.594309491878234,0.480846224958199]]);
    //print('alpha',alpha_coefficients_GREEN) 
    
    
    
    var XDX_pre_calc_GREEN =  ee.Image([[0.123598368782935],[0.105158132426881],[0.072786609164660],[0.054727794650632],[0.038810533127475],[0.137553995329753],[2.292339151308235],[3.752667628967179],[1.648176490994309],[2.753290235420747],[0.194132523282140],
    [0.288998434735805],[3.879772668062411],[2.854988282491563],[2.717688137209260],[0.285005918295687],[0.255257894245747],[0.405129361573469],[0.038760412998415],[0.336594012869702],[0.403659456302244],[0.331556995909372],
    [0.387811237922942],[1.804023879994751],[0.799151506654465],[0.595889284187595],[1.735683577000902],[0.639037557300725],[0.468518175375072],[1.819736431758778],[1.121926042611090],[0.678219942546031],[0.669593845101840],[0.848889978225546],
    [0.528354723496899],[0.534688038679387],[0.091201354517546],[0.050283129991537],[0.119278076669461],[0.925622638947682],[0.132548608967066],[0.178527037203375],[0.153341006725799],[0.137051888731692],[0.181602950447044],[0.243923036318534],[0.081855062248491],
    [0.099155852479285],[0.545320781984131],[0.498481686499949],[0.109770562033467],[0.104144293358203],[0.116938387109160],[0.133554246025410],[0.217547327986620],[1.324414575197972],[0.822452779755387],[0.033147912717577],[0.394354369268043],[0.998040647023507],
    [0.346761196616069],[0.173785177649943],[0.282370999177787],[1.339730681933823],[0.290843097494182],[0.273879132218633],[0.527628702311476],[0.282649647403469],[0.419956880102286],[0.132720362630920],[0.199539935617798],[0.775121265121194],[2.795586325807243],
    [1.477390753252041],[2.101402737215561],[2.586447471245120],[1.234528218918266],[6.288801778830771],[2.260938738686914],[4.323125044817612],[2.770118138438976],[4.003165875713197],[0.145176173317417],[0.405066811249545],[0.082872268686415],[0.195684712530249],
    [0.103607491763498],[0.124014197697684],[0.096584450985405],[0.265505642253941],[5.223827099926961],[6.176433519174031]]).multiply(1.0e+02)
    
    
    var mx_GREEN       =  ee.Image([[0.702310514018692, 1.176265981308411, 1.251145327102803, 1.862997943925234, 3.387931775700936, 4.014621495327103, 4.123949532710281, 4.202986915887850, 2.673046261682243, 1.914826915887850]]).multiply(1.0e+03);
    var sx_GREEN       =  ee.Image([[0.655971482423783, 0.758195193382470, 1.196367417239195, 1.072352482794430, 1.046753963504474, 1.274393675257290, 1.281678560544128, 1.260072495647808, 1.352427774632083, 1.338730944262033]]).multiply(1.0e+03);
    
    var hyp_ell_GREEN  = ee.Image([ 0.032124524195884, 0.554867257702808, 1.203986333935225, 0.628584416839876, 0.153453138908881,   0.029485623355712,   0.793411095202464,   0.018936975932916,   0.218937397760409,  0.011012877949540]);
    var hyp_sign_GREEN = ee.Array([0.290407140728506]);
    var hyp_sig_GREEN  = 8.223046286059438;
    
    // GPR hyperparameters for time series gapfilling
    var ell2_ts  =  0.006294261816321;
    var sigf_ts  =  1.067814250519564;
    var sign_ts  =  0.203580521664474; 
    //-----------------------------------------------------------------------------------//
    
    
    // Cloudy pixels filtering functions
    
    function maskS2clouds(image) {
      var qa = image.select('QA60');
      // Bits 10 and 11 are clouds and cirrus, respectively.
      var cloudBitMask = 1 << 10;
      var cirrusBitMask = 1 << 11;
      // Both flags should be set to zero, indicating clear conditions.
      var mask = qa.bitwiseAnd(cloudBitMask).eq(0)
          .and(qa.bitwiseAnd(cirrusBitMask).eq(0));
      return image.updateMask(mask);//.divide(10000);
    }
    
    
    // A function to mask out cloudy pixels.
    var clouds = function(image) {
      // Select the QA band.
      var QA = image.select(['QA60']);
      // Get the internal_cloud_algorithm_flag bit.
      return getQABits(QA, 10,10, 'cloud');
      // Return an image masking out cloudy areas.
    };
    
      
    
    // time vector definition for time series gap-filling
    var addVariables = function(image){
      var date = ee.Date(image.get("system:time_start"));
      var years = date.difference(ee.Date('1970-01-01'),'days');
      return image.addBands(ee.Image(years).rename('t').float())
    }

    var LAI_coll = dateOfInterestColl.map(function (dateOfInterest1) {
  
    // time
    var time_span_days      = 20
    var dateOfInterest = dateOfInterest1[0]
    // print(dateOfInterest)
    var Date_Start_str      = ee.Date(dateOfInterest).advance(-time_span_days,'day')//.aside(print,'Date_Start_str');
    
    var Date_End_str        = ee.Date(dateOfInterest).advance(time_span_days,'day')//.aside(print);
    var dateOfInterest_num  = ee.Date(dateOfInterest).difference(ee.Date('1970-01-01'),'days');
    
    // Function predicting LAI from S2 L2A acquisition using pretrained GPR model
    var calculate_LAI_GREEN = function(image_orig){
          //Create a list of band names for flattening operation 
          var im_norm_ell2D_hypell = image_orig.subtract(mx_GREEN).divide(sx_GREEN).multiply(hyp_ell_GREEN).toArray().toArray(1); 
          var im_norm_ell2D = image_orig.subtract(mx_GREEN).divide(sx_GREEN).toArray().toArray(1); 
          
          var PtTDX  = ee.Image(X_train_GREEN).matrixMultiply(im_norm_ell2D_hypell).arrayProject([0]).arrayFlatten([sequence_GREEN]);
          var PtTPt  = im_norm_ell2D_hypell.matrixTranspose().matrixMultiply(im_norm_ell2D).arrayProject([0]).multiply(-0.5); //OK
          var arg1   = PtTPt.exp().multiply(hyp_sig_GREEN)
          var k_star = PtTDX.subtract(XDX_pre_calc_GREEN.multiply(0.5)).exp().toArray()
          var mean_pred = k_star.arrayDotProduct(alpha_coefficients_GREEN.toArray()).multiply(arg1);
          mean_pred = mean_pred.toArray(1).arrayProject([0]).arrayFlatten([['LAI_GREEN']]);
          mean_pred = mean_pred.updateMask(mean_pred.gt(0));
          image_orig= image_orig.addBands(mean_pred)
          return image_orig};
           
  
    
    // S2 collection
    var S2collection_ini = ee.ImageCollection('COPERNICUS/S2_SR')
                    .filterDate(Date_Start_str,Date_End_str)
                    .filterBounds(roi)
                    .filterMetadata('CLOUDY_PIXEL_PERCENTAGE', 'less_than', 30) 
                    .map(maskS2clouds)
                    .map(function(image){return image.clip(roi)})
  
            
    var LAI_min_th       = 0;
    var LAI_max_th       = 4;
    
    // add time images
    var time_star_im_Im  = S2collection_ini.map(addVariables).select('t').first().multiply(0).add(dateOfInterest_num);
    
    var S2collection     = S2collection_ini.select(['B2', 'B3', 'B4', 'B5', 'B6', 'B7', 'B8', 'B8A', 'B11', 'B12']);
    var Nsize            = S2collection.size();
    var XTrain_GREEN_dim = X_train_GREEN.length().toList().get(0);
    var sequence_GREEN   = ee.List.sequence(1, XTrain_GREEN_dim).map(function(element){ return ee.String('B').cat(ee.String(element)).slice(0,3).replace('[.]','','')});
  
    // LAI maps are retrieved
    var LAIG_collection     = S2collection.map(calculate_LAI_GREEN).select('LAI_GREEN')//.aside(print,'LAIG_collection');
    var LAIG_collection_msk = LAIG_collection.map(function(image){var LAI_mask = image.select('LAI_GREEN').gt(0); return LAI_mask.rename('LAI_mask')});
  
    // Max-reducer is applied to display one image
    var mosaic_LAIGmax    = LAIG_collection.reduce(ee.Reducer.max()); 
    var mosaic_LAIGmax_th = mosaic_LAIGmax.mask(mosaic_LAIGmax.gt(LAI_min_th))
    
    
    // TIME-stamp is generated for each element of the collection and stacked into a multi-band image
    var time_im_Im  = S2collection_ini.map(addVariables).select('t').toBands();
    var time_Im_msk = LAIG_collection_msk.toBands().multiply(time_im_Im); 
    
    // Unmask operation is compulsory in order to avoid always-masked vectors
    var t_vec_sel  = time_Im_msk.unmask().toArray().toArray(1);
    var time_im_Im_names = time_im_Im.bandNames();
    var pred_name        = ee.List(time_im_Im_names).get(12)// get name of 1 image
    var t_star_vec = time_star_im_Im.toArray().toArray(1); // time start image to array
    
    
    // LAI time series converted to vector
    var lai_vec_Im      = LAIG_collection.toBands();// collection to bands (LAI bands)
    var lai_vec_ImNames = lai_vec_Im.bandNames();// get LAI band list
    var lai_vec_sel     = lai_vec_Im.unmask().toArray().toArray(1); //to array
    var ones_vec_sel  = t_vec_sel.multiply(0).add(1.0);//time image with value =1
    var ones_vec_star = t_star_vec.multiply(0).add(1.0);// first time image with value =1
    
    var II_mat        = ee.Image(ee.Array.identity(Nsize)); 
    var prod          = t_vec_sel.matrixMultiply(ones_vec_sel.matrixTranspose());
    var K_mat         = prod.subtract(prod.matrixTranspose()).pow(2).multiply(ell2_ts).multiply(-0.5).exp().multiply(sigf_ts)
    var alpha_vec     = II_mat.multiply(sign_ts).add(K_mat).matrixInverse().matrixMultiply(lai_vec_sel)
    
    var t_star_mat  = t_star_vec.matrixMultiply(ones_vec_sel.matrixTranspose());
    var t_train_mat = t_vec_sel.matrixMultiply(ones_vec_star.matrixTranspose()).matrixTranspose();
    var k_star_mat  = t_star_mat.subtract(t_train_mat).pow(2).multiply(ell2_ts).multiply(-0.5).exp().multiply(sigf_ts)
    var pred_vec    = k_star_mat.matrixMultiply(alpha_vec)//.aside(print,'pred_vec');
    var pred_vec    = pred_vec.arrayProject([0]).arrayFlatten([[dateOfInterest]])//.aside(print,'pred_vec');// return a LAI map Layer
    // var namefile = ee.Date(dateOfInterest).format('YYYYMMdd').getInfo()
    var namefile = dateOfInterest//.format('YYYYMMdd').getInfo()
    return pred_vec.clip(roi).rename('lai').set('system:index', namefile);
  });
  
  
  // // dislay a layer
  // print(LAI_coll)
  // var LAIG_palette =['#FFFFFF','#FFFFFF','#FFFFFF','#FFFFFF','#FFFFFF','#FFFFFF','#FFFFFF','#FFFFFF','#FFFFFF','#FFFFFF','#FFFFFF','#FDFEFB','#FBFDF8','#FAFCF4','#F8FBF1','#F6FAED','#F5F9EA','#F3F8E6','#F2F7E3','#F0F6DF','#EEF5DC','#EDF4D9','#EBF3D5','#EAF2D2','#E8F1CE','#E6F0CB','#E5EFC7','#E3EEC4','#E1EDC0','#E0ECBD','#DEEBBA','#DDEAB6','#DBE9B3','#D9E8AF','#D8E7AC','#D5E5A5','#D3E4A1','#D1E39E','#D0E29B','#CEE197','#CCE094','#CBDF90','#C9DE8D','#C8DD89','#C6DC86','#C4DB82','#C3DA7F','#C1D97C','#C0D878','#BED775','#BCD671','#BBD56E','#B9D46A','#B7D367','#B6D263','#B4D160','#B3D05D','#B1CF59','#AFCE56','#AECD52','#ABCB4B','#A9CA48','#A7C944','#A6C841','#A4C73E','#A3C63A','#A1C537','#9FC433','#9EC330','#9CC22C','#9AC129','#99C025','#97BF22','#96BE1F','#94BD1B','#92BC18','#91BB14','#8FBA11','#8EB90D','#8CB80A','#8AB706','#89B603','#87B500','#85B400','#82B200','#81B100','#7FB000','#7DAF00','#7CAE00','#7AAD00','#79AC00','#77AB00','#75AA00','#74A900','#72A800','#70A700','#6FA600','#6DA500','#6CA400','#6AA300','#68A200','#67A100','#65A000','#649F00','#629E00','#609D00','#5F9C00','#5D9B00','#5B9A00','#589800','#579700','#559600','#539500','#529400','#509300','#4F9200','#4D9100','#4B9000','#4A8F00','#488E00','#478D00','#458C00','#438B00','#428A00','#408900','#3E8800','#3D8700','#3B8600','#3A8500','#388400','#368300','#358200','#338100','#328000','#2E7E00','#2D7D00','#2B7C00','#297B00','#287A00','#267900','#257800','#237700','#217600','#207500','#1E7400','#1D7300','#1B7200','#197100','#187000','#166F00','#146E00','#136D00','#116C00','#106B00','#0E6A00','#0C6900','#0B6800','#096700','#066500','#046400','#036300','#016200','#006100','#006000','#005F00','#005E00','#005D00','#005C00','#005B00','#005A00','#005900','#005800','#005700','#005600','#005500','#005400','#005300','#005200','#005100','#005000','#004F00','#004E00','#004D00','#004B00','#004A00','#004900','#004800','#004700','#004600','#004500','#004400','#004300','#004200','#004100','#004000','#003F00','#003E00','#003D00','#003C00','#003B00','#003A00','#003900','#003800','#003700','#003600','#003500','#003400','#003200','#003100','#003000','#002F00','#002E00','#002D00','#002C00','#002B00','#002A00','#002900','#002800','#002700','#002600','#002500','#002400','#002300','#002200','#002100','#002000','#001F00','#001E00','#001D00','#001C00','#001B00','#001A00','#001800','#001700','#001600','#001500','#001400','#001300','#001200','#001100','#001000','#000F00','#000E00','#000D00','#000C00','#000B00','#000A00','#000900','#000800','#000700','#000600','#000500','#000400','#000300','#000200','#000100'];
  // var LAI_band = ee.Image(LAI_coll[1])// select a band
  // Map.addLayer(LAI_band,{max:4,min:0,palette:LAIG_palette},'predicted_LAI')
  // print(LAI_coll)
  // // field boundary
  // var styling = {color: 'red', fillColor: '00000000'};
  // Map.addLayer(table.style(styling))
  // Map.addLayer(boundary)
  
  var laiCollection = ee.ImageCollection(LAI_coll).toBands()

  return laiCollection
  
}
